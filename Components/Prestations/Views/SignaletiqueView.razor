@using Coossi.Blazor.Data.Interfaces
@using Coossi.Blazor.Data.Models
@using Coossi.Blazor.Data.Models.Prestations
@inject IContentStore Content
@inject NavigationManager Nav

@code {
  [Parameter] public string Slug { get; set; } = "";
  private SignaletiquePage? Model;
  protected override async Task OnParametersSetAsync()
    => Model = await Content.GetAsync<SignaletiquePage>($"prestations/{Slug}");
  string Canonical => $"{Nav.BaseUri.TrimEnd('/')}/prestation/{Slug}";
}

@if (Model is null) { <section class="content-section"><div class="container">Chargement…</div></section> }
else {
  <Seo Title="@Model.Seo.MetaTitle" Description="@Model.Seo.MetaDescription" Canonical="@Canonical" OgImage="@(Model.Seo.OgImage ?? "images/og-prestations.webp")" />
  <PageHeader Title="@Model.Hero.Title" Lead="@Model.Hero.Subtitle" />

  <section class="content-section"><div class="container">
    <div class="info-card"><h2 class="section-title">L’importance de la signalétique</h2><p>@Model.ImportanceText</p></div>
    <div class="info-card mt-4"><h3>Conformité aux normes</h3><p>@Model.ConformiteText</p></div>
  </div></section>

  @* Exemples de familles en grille 2×2 *@
  @renderCards("Plans d’évacuation", Model.PlansEvacuation)
  @renderCards("Panneaux directionnels", Model.Directionnels)
  @renderCards("Signalisation des équipements", Model.Equipements)
  @renderCards("Panneaux d’interdiction", Model.Interdictions)
  @renderCards("Consignes de sécurité", Model.Consignes)
  @renderCards("Balisage lumineux", Model.Balisage)

  <section class="content-section"><div class="container"><h2 class="section-title">Pictogrammes principaux</h2>
    <div class="row">@foreach (var p in Model.Pictos){
      <div class="col-lg-3 col-md-4 mb-4"><div class="info-card h-100 text-center">
        @if (!string.IsNullOrWhiteSpace(p.Icon)) { <i class="fas @p.Icon fa-2x mb-2" style="color:var(--primary-color);"></i> }
        <h4 class="mb-0">@p.Title</h4>
      </div></div> }
    </div>
  </div></section>

  <section class="content-section"><div class="container"><h2 class="section-title">Matériaux & supports</h2>
    <div class="row">@foreach (var m in Model.MateriauxSupports){
      <div class="col-lg-4 mb-4"><div class="info-card h-100"><h3>@m.Title</h3>@if (!string.IsNullOrWhiteSpace(m.Text)){<p>@m.Text</p>}</div></div>
    }</div>
  </div></section>

  <section class="content-section"><div class="container">
    <div class="row">
      <div class="col-lg-6 mb-4"><div class="info-card h-100"><h3>Étude & conception</h3><p>@Model.EtudeConceptionText</p></div></div>
      <div class="col-lg-6 mb-4"><div class="info-card h-100"><h3>Réalisation & pose</h3><p>@Model.RealisationPoseText</p></div></div>
    </div>
  </div></section>

  <section class="content-section"><div class="container"><div class="info-card">
    <h2 class="section-title">Établissements concernés</h2><ul>@foreach (var e in Model.Etablissements){ <li>@e</li> }</ul>
  </div></div></section>

  <section class="content-section"><div class="container"><h2 class="section-title">Zones d’intervention</h2><div class="city-links">
    @foreach (var c in Model.Cities) { <a>@c</a> }
  </div></div></section>

  <CtaBar Title="@Model.Cta.Title" Text="@Model.Cta.Text" CtaText="@Model.Cta.ButtonText" CtaHref="@Model.Cta.ButtonHref" IconClass="fas fa-comments" />
}

@code {
  RenderFragment renderCards(string title, List<SigCard> items) => __builder =>
  {
    if (items is null || items.Count == 0) return;
    __builder.AddMarkupContent(0, $@"<section class=""content-section""><div class=""container""><h2 class=""section-title"">{title}</h2><div class=""row"">");
    var seq = 1;
    foreach (var it in items)
    {
        __builder.AddMarkupContent(seq++, @"<div class=""col-lg-6 mb-4""><div class=""info-card h-100"">");
        __builder.AddMarkupContent(seq++, $"<h3>{it.Title}</h3>");
        if (!string.IsNullOrWhiteSpace(it.Text)) __builder.AddMarkupContent(seq++, $"<p>{it.Text}</p>");
        if (it.Bullets is { Count: > 0 })
        {
            __builder.AddMarkupContent(seq++, "<ul>");
            foreach (var b in it.Bullets) __builder.AddMarkupContent(seq++, $"<li>{b}</li>");
            __builder.AddMarkupContent(seq++, "</ul>");
        }
        __builder.AddMarkupContent(seq++, "</div></div>");
    }
    __builder.AddMarkupContent(seq++, "</div></div></section>");
  };
}

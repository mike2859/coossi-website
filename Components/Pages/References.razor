@page "/references"
@using Coossi.Blazor.Data.Interfaces
@using Coossi.Blazor.Data.Models
@inject IContentStore ContentStore

@code {
    private RealisationsPage? Page; // réutilise ton DTO existant
    protected override async Task OnInitializedAsync()
        => Page = await ContentStore.GetAsync<RealisationsPage>("references"); // Content/references.json
}

@if (Page is null)
{
    <section class="section-padding" style="margin-top:76px">
        <div class="container text-center text-muted">
            <div class="spinner-border text-danger"></div>
            <p class="mt-3">Chargement…</p>
        </div>
    </section>
}
else
{
    <section class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="display-4 fw-bold mb-4">@Page.Title</h1>
                    @if (!string.IsNullOrWhiteSpace(Page.Lead)) { <p class="lead">@Page.Lead</p> }
                </div>
            </div>
        </div>
    </section>

    @* 1) Stats *@
    @foreach (var s in Page.Sections.Where(x => x.Kind == "stats" && x.Items is not null))
    {
        <section class="stats-section section-padding">
            <div class="container">
                <div class="row">
                    @foreach (var it in s.Items!)
                    {
                        <div class="col-lg-3 col-md-6">
                            <div class="stat-item text-center">
                                <span class="stat-number">@it.Number</span>
                                <h5>@it.Title</h5>
                                <p class="text-light">@it.Text</p>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>
    }

    @* 2) Témoignages via COMPOSANT JSON dédié *@
    <section class="section-padding">
        <div class="container">
            <TestimonialsGrid JsonId="testimonials" />
        </div>
    </section>

    @* 3) Missions *@
    @foreach (var s in Page.Sections.Where(x => x.Kind == "missions" && x.Cards2 is not null))
    {
        <section class="section-padding bg-light">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 mx-auto text-center mb-5">
                        <h2 class="display-6 fw-bold mb-3">@s.Title</h2>
                        @if (!string.IsNullOrWhiteSpace(s.Lead)) { <p class="lead">@s.Lead</p> }
                    </div>
                </div>
                <div class="row g-4">
                    @foreach (var m in s.Cards2!)
                    {
                        <div class="@(m.Title?.Contains("Dossier") == true || m.Title?.Contains("Conformité") == true ? "col-lg-6" : "col-lg-4")">
                            <div class="mission-card h-100">
                                <span class="mission-type">@m.Type</span>
                                <h5 class="fw-bold">@m.Title</h5>
                                @if (m.Bullets?.Count > 0)
                                { <div class="text-muted">@foreach (var b in m.Bullets) { @($"• {b}")<br /> }</div> }
                                @if (!string.IsNullOrWhiteSpace(m.Note))
                                { <small class="text-muted"><i class="fas @(m.NoteIcon ?? "fa-map-marker-alt") @(m.NoteClass ?? "") me-1"></i>@m.Note</small> }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>
    }

    @* 4) Zone/CTA (si présents) *@
    @foreach (var s in Page.Sections.Where(x => x.Kind == "zone" && x.Box is not null))
    {
        <section class="section-padding">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h2 class="display-6 fw-bold mb-4">@s.Title</h2>
                        @if (!string.IsNullOrWhiteSpace(s.Lead)) { <p class="lead mb-4">@((MarkupString)s.Lead)</p> }
                        <div class="row g-3">
                            <div class="col-md-6">
                                <h6 class="fw-bold">@s.AreasTitle</h6>
                                <ul class="list-unstyled">
                                    @if (s.Areas is not null) { foreach (var a in s.Areas) { <li><i class="fas fa-map-marker-alt text-danger me-2"></i>@a</li> } }
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold">@s.CitiesTitle</h6>
                                <ul class="list-unstyled">
                                    @if (s.Cities is not null) { foreach (var c in s.Cities) { <li><i class="fas fa-city text-danger me-2"></i>@c</li> } }
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="geographic-coverage">
                            <i class="fas @s.Box.Icon display-4 mb-3"></i>
                            <h5 class="fw-bold">@s.Box.Title</h5>
                            <p class="mb-0">@s.Box.Text</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    }

    @foreach (var s in Page.Sections.Where(x => x.Kind == "cta"))
    {
        <section class="section-padding bg-dark text-white">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h2 class="display-6 fw-bold mb-3">@s.Title</h2>
                        <p class="lead mb-0">@s.Text</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        @if (!string.IsNullOrWhiteSpace(s.Phone) && !string.IsNullOrWhiteSpace(s.PhoneHref))
                        { <a href="@s.PhoneHref" class="btn btn-custom btn-lg me-3"><i class="fas fa-phone me-2"></i>@s.Phone</a> }
                        @if (!string.IsNullOrWhiteSpace(s.ContactHref))
                        { <a href="@s.ContactHref" class="btn btn-outline-light btn-lg"><i class="fas fa-envelope me-2"></i>Contact</a> }
                    </div>
                </div>
            </div>
        </section>
    }
}

@page "/prestation/{slug}"
@using Coossi.Blazor.Components.Shared
@using Coossi.Blazor.Data.Interfaces
@using Coossi.Blazor.Data.Models
@inject IPrestationStore Store
@inject NavigationManager Nav

@code {
    [Parameter] public string slug { get; set; } = "";
    private PrestationPageDto? Model;
    private Type? RendererType;

    // mapping slug -> composant de rendu spécifique
    private static readonly IReadOnlyDictionary<string, Type> Map = new Dictionary<string, Type>(StringComparer.OrdinalIgnoreCase)
    {
        ["coordination-ssi"] = typeof(Coossi.Blazor.Components.Prestations.Views.CoordinationView),
        ["creation-dossier-ssi"] = typeof(Coossi.Blazor.Components.Prestations.Views.DossierSsiView),
        ["notices-securite-accessibilite"] = typeof(Coossi.Blazor.Components.Prestations.Views.NoticesView),
        ["audit-diagnostic"] = typeof(Coossi.Blazor.Components.Prestations.Views.AuditDiagnosticView),
        ["assistance-moe"] = typeof(Coossi.Blazor.Components.Prestations.Views.AssistanceMoeView),
        ["responsable-unique-securite"] = typeof(Coossi.Blazor.Components.Prestations.Views.RusView),
        ["document-unique-evaluation"] = typeof(Coossi.Blazor.Components.Prestations.Views.DuerView),
        ["signaletique"] = typeof(Coossi.Blazor.Components.Prestations.Views.SignaletiqueView),
        // … ajoute tes autres slugs au fur et à mesure
    };

    protected override async Task OnParametersSetAsync()
    {
        Model = await Store.GetBySlugAsync(slug);
        RendererType = Model is null ? null : (Map.TryGetValue(Model.Slug, out var t) ? t : typeof(Coossi.Blazor.Components.Prestations.Views.GenericPrestationView));
    }

    string Canonical => $"{Nav.BaseUri.TrimEnd('/')}/prestation/{slug}";
}

@if (Model is null)
{
    <section class="content-section text-center text-muted">
        <div class="container">
            <div class="spinner-border text-danger"></div>
            <p class="mt-3">Chargement…</p>
        </div>
    </section>
}
else
{
    <!-- SEO -->
    <Seo Title="@Model.MetaTitle"
         Description="@Model.MetaDescription"
         Canonical="@Canonical"
         OgImage="@(Model.OgImage ?? "images/og-prestations.webp")" />

    <!-- Header -->
    <PageHeader Title="@Model.Title" Lead="@Model.Subtitle" />

    <!-- Rendu spécifique -->
    <DynamicComponent Type="@(RendererType!)" Parameters="@(new Dictionary<string, object?> { ["Model"] = Model })" />
}
